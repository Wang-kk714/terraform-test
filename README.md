API Tokens
```bash
export PM_API_TOKEN_ID='terraform-prov@pve!terraform'
export PM_API_TOKEN_SECRET='ed1182db-867e-4f29-b02d-efb1a264c55f'

$env:TF_VAR_pm_api_token_id='terraform-prov@pve!terraform'; $env:TF_VAR_pm_api_token_secret='ed1182db-867e-4f29-b02d-efb1a264c55f'; 
```

cloud-init -> template
```bash
qm create 9001 --name ubuntu-noble --memory 2048 --cores 2 --net0 virtio,bridge=vmbr0
qm importdisk 9001 noble-server-cloudimg-amd64.img local-lvm

qm set 9001 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-9001-disk-0
qm set 9001 --boot order=scsi0
qm set 9001 --ide2 local-lvm:cloudinit
qm set 9001 --agent enabled=1
qm template 9001
```

| **å‘½ä»¤**                                                                                  | **ç›®çš„**                | **è¯¦ç»†è¯´æ˜**                                                                                                                                                                                                                                                         |
| --------------------------------------------------------------------------------------- | --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `qm create 9001 --name ubuntu-noble --memory 2048 --cores 2 --net0 virtio,bridge=vmbr0` | **åˆ›å»ºåŸºç¡€ VM é…ç½®**        | ä½¿ç”¨ ID `9001` åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿæœºï¼š<br>â€¢ `--name ubuntu-noble`: è®¾ç½® VM åç§°ä¸º `ubuntu-noble`ã€‚<br>â€¢ `--memory 2048`: åˆ†é… 2048 MB (2 GB) å†…å­˜ã€‚<br>â€¢ `--cores 2`: åˆ†é… 2 ä¸ª CPU æ ¸å¿ƒã€‚<br>â€¢ `--net0 virtio,bridge=vmbr0`: åˆ›å»ºç¬¬ä¸€ä¸ªç½‘ç»œæ¥å£ï¼ˆ`net0`ï¼‰ï¼Œä½¿ç”¨ `virtio` é©±åŠ¨ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰ï¼Œå¹¶æ¡¥æ¥åˆ° Proxmox çš„é»˜è®¤ç½‘æ¡¥ `vmbr0`ã€‚ |
| `qm importdisk 9001 noble-server-cloudimg-amd64.img local-lvm`                          | **å¯¼å…¥ç£ç›˜é•œåƒ**            | å°†ä¸‹è½½çš„ Cloud-Init é•œåƒæ–‡ä»¶ (`noble-server-cloudimg-amd64.img`) å¯¼å…¥åˆ° ID ä¸º `9001` çš„ VM ä¸­ï¼Œå¹¶å°†å®é™…çš„è™šæ‹Ÿç£ç›˜æ–‡ä»¶å­˜å‚¨åœ¨åä¸º `local-lvm` çš„å­˜å‚¨æ± ä¸­ã€‚                                                                                                                                              |
| `qm set 9001 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-9001-disk-0`                 | **è®¾ç½®ç£ç›˜ç¡¬ä»¶å’Œå¯åŠ¨ç›˜**        | â€¢ `--scsihw virtio-scsi-pci`: æŒ‡å®šä½¿ç”¨é«˜æ€§èƒ½çš„ VirtIO SCSI æ§åˆ¶å™¨ï¼ˆæ¨èç”¨äº Linux VMï¼‰ã€‚<br><br>â€¢ `--scsi0 local-lvm:vm-9001-disk-0`: å°†ä¸Šä¸€æ­¥å¯¼å…¥çš„ç£ç›˜ï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨å‘½åä¸º `vm-9001-disk-0`ï¼‰ä½œä¸º VM çš„ç¬¬ä¸€ä¸ª SCSI è®¾å¤‡ (`scsi0`) æŒ‚è½½ã€‚                                                                         |
| `qm set 9001 --boot order=scsi0`                                                        | **è®¾ç½®å¼•å¯¼é¡ºåº**            | æ˜ç¡®å‘Šè¯‰ VM çš„ BIOS **ä» `scsi0` è®¾å¤‡å¯åŠ¨**ï¼ˆå³ä»ä¸Šä¸€æ­¥æŒ‚è½½çš„ç³»ç»Ÿç£ç›˜å¯åŠ¨ï¼‰ã€‚è¿™æ˜¯ä¿è¯ VM èƒ½å¤Ÿå¼•å¯¼æ“ä½œç³»ç»Ÿçš„å…³é”®ã€‚                                                                                                                                                                                           |
| `qm set 9001 --ide2 local-lvm:cloudinit`                                                | **è®¾ç½® Cloud-Init é©±åŠ¨å™¨** | åœ¨ VM çš„ `ide2` æ§½ä½ï¼ˆé€šå¸¸æ˜¯ CD-ROMï¼‰ä¸ŠæŒ‚è½½ä¸€ä¸ª **Cloud-Init é©±åŠ¨å™¨**ã€‚è¿™ä¸ªé©±åŠ¨å™¨åœ¨æ¯æ¬¡ VM å¯åŠ¨æ—¶éƒ½ä¼šç”Ÿæˆå¹¶åŒ…å«é…ç½®æ•°æ®ï¼ˆå¦‚ IP åœ°å€ã€ç”¨æˆ·åã€SSH å¯†é’¥ç­‰ï¼‰ã€‚                                                                                                                                                            |
| `qm set 9001 --agent enabled=1`                                                         | **å¯ç”¨ QEMU ä»£ç†**        | å¯ç”¨ **QEMU Guest Agent**ã€‚è¿™ä¸ªä»£ç†å…è®¸ Proxmox ä¸»æœºä¸ VM å†…éƒ¨çš„æ“ä½œç³»ç»Ÿè¿›è¡Œé€šä¿¡ï¼Œä»è€Œå®ç°ä¼˜é›…å…³æœºã€è·å– IP åœ°å€å’Œæ–‡ä»¶ç³»ç»Ÿå†»ç»“ç­‰é«˜çº§åŠŸèƒ½ã€‚                                                                                                                                                                         |
| `qm template 9001`                                                                      | **è½¬æ¢ä¸ºæ¨¡æ¿**             | å°† ID ä¸º `9001` çš„è™šæ‹Ÿæœºæ ‡è®°ä¸º**æ¨¡æ¿**ã€‚æ¨¡æ¿ä¸èƒ½ç›´æ¥è¿è¡Œï¼Œä½†å¯ä»¥è¢«å¿«é€Ÿã€é‡å¤åœ°å…‹éš†æˆæ–°çš„ã€å¯è¿è¡Œçš„ VM å®ä¾‹ï¼ˆå°±åƒæ‚¨åœ¨ Terraform ä¸­åšçš„é‚£æ ·ï¼‰ã€‚                                                                                                                                                                           |
- **Terraform é…ç½®**ï¼šæ‚¨åœ¨ `proxmox_vm_qemu` èµ„æºå—ä¸­å®šä¹‰çš„ `ciuser`, `sshkeys`, `ipconfig0` ç­‰å‚æ•°ï¼Œéƒ½è¢« Terraform è½¬æ¢ä¸ºæ ‡å‡†çš„ Cloud-init æ•°æ®æ ¼å¼ã€‚
    
- **é©±åŠ¨å™¨åˆ›å»º**ï¼šå½“æ‚¨éƒ¨ç½² VM æ—¶ï¼ŒProxmox ä¼šåœ¨æ‚¨çš„å­˜å‚¨æ± ä¸Šï¼ˆä¾‹å¦‚ `local-lvm`ï¼‰**åŠ¨æ€ç”Ÿæˆ**ä¸€ä¸ªåŒ…å«è¿™äº›é…ç½®æ•°æ®çš„ **Cloud-init CD-ROM é•œåƒ**ã€‚
    
- **æŒ‚è½½**ï¼šè¿™ä¸ª CD-ROM é•œåƒè¢«æŒ‚è½½åˆ°æ–° VM çš„ `ide2` æ§½ä½ä¸Šã€‚
    
- **ç³»ç»Ÿè¯»å–**ï¼šVM å¯åŠ¨åï¼Œå†…æ ¸åŠ è½½ Cloud-init æœåŠ¡ã€‚Cloud-init æœåŠ¡æ£€æµ‹åˆ°è¿™ä¸ª CD-ROM é©±åŠ¨å™¨ï¼Œè¯»å–æ•°æ®ï¼Œå¹¶æ‰§è¡Œæ‰€æœ‰é…ç½®ä»»åŠ¡ï¼ˆåˆ›å»ºç”¨æˆ·ã€è®¾ç½®ç½‘ç»œã€æ³¨å…¥å¯†é’¥ç­‰ï¼‰ã€‚
    
- **å®Œæˆ**ï¼šé…ç½®å®Œæˆåï¼ŒCloud-init æ ‡è®°è‡ªå·±å·²å®Œæˆï¼Œé€šå¸¸ä¼šåœ¨æ—¥å¿— `/var/log/cloud-init-output.log` ä¸­è®°å½•ç»“æœã€‚


# template å­˜æ”¾åœ¨NFSä¸Šçš„é—®é¢˜

```
root@pve:/mnt/pve/truenas/images/9002# qm config 9002
agent: enabled=1
boot: order=scsi0
cores: 2
ide2: truenas:9002/vm-9002-cloudinit.raw,media=cdrom,size=4M
memory: 2048
meta: creation-qemu=10.1.2,ctime=1764310864
name: Copy-ubuntu-noble
net0: virtio=BC:24:11:57:AF:23,bridge=vmbr0
scsi0: truenas:9002/vm-9002-disk-0.raw,size=3584M
scsihw: virtio-scsi-pci
smbios1: uuid=834a24db-2efb-45e9-a652-a6d1a6a795cb
template: 1
vmgenid: 3a18725c-c6c2-422f-838d-3658a04349b0

```

| **é˜¶æ®µ**       | **æ ¸å¿ƒé—®é¢˜**                                                                 | **è¡¨ç°/é”™è¯¯**                                                      | **è§£å†³æ–¹æ¡ˆ**                                                                                                                                                                                                 |
| ------------ | ------------------------------------------------------------------------ | -------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **I. åˆå§‹è¯Šæ–­**  | **éæ ‡å‡†çš„æ¨¡æ¿ç£ç›˜å‘½å**ï¼šCloud-init æ¨¡æ¿å¯¼å…¥åï¼Œä¸»ç£ç›˜æ–‡ä»¶ä½¿ç”¨äº†éæ ‡å‡†çš„ `base-VMID-disk-ID.raw` å‘½åã€‚ | `Error: volume 'truenas:101/vm-101-disk-0.raw' does not exist` | **åŸç†åˆ†æï¼š** LVM å­˜å‚¨å¯ä»¥å®¹å¿éæ ‡å‡†å‘½åï¼Œä½† NFS/Directory ç­‰æ–‡ä»¶å­˜å‚¨åœ¨å…‹éš†æ—¶å¿…é¡»æ‰¾åˆ°æ ‡å‡†çš„ `vm-VMID-disk-ID.raw` æºæ–‡ä»¶ã€‚                                                                                                                    |
| **II. å‘½åä¿®æ­£** | **æ‰‹åŠ¨é‡å‘½åä¸å½»åº•**ï¼šæ‚¨æ‰‹åŠ¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šé‡å‘½åäº†ç£ç›˜ï¼Œä½†åœ¨ Proxmox é…ç½®ä¸­ç•™ä¸‹äº†æ®‹ç•™å¼•ç”¨ã€‚                      | `qm config 9002` ä¸­æ˜¾ç¤ºäº† `unused0: ...base-9002-disk-0.raw`ã€‚      | 1. **é‡å‘½åï¼š** å°† `base-9002-disk-0.raw` æ”¹ä¸º `vm-9002-disk-0.raw`ã€‚ 2. **`qm set` æ›´æ–°é…ç½®ï¼š** ç¡®ä¿ `scsi0` æŒ‡å‘æ–°çš„ `vm-` æ–‡ä»¶ã€‚<br><br>qm set 9002 --scsi0 truenas:9002/vm-9002-disk-0.raw<br>qm set 9002 --delete unused0 |
| **æœ€ç»ˆåŒæ­¥**     | **ç¼“å­˜æœªåˆ·æ–°**ï¼šProxmox/Terraform ä»åœ¨ä½¿ç”¨æ—§çš„é…ç½®ä¿¡æ¯ã€‚                                  | é”™è¯¯é‡å¤å‡ºç°ã€‚                                                        | 1. **Proxmox å¼ºåˆ¶åŒæ­¥ï¼š** ä½¿ç”¨ `qm set 9002 --template 0` ç„¶å `qm set 9002 --template 1` å¼ºåˆ¶ Proxmox åˆ·æ–°é…ç½®ã€‚ 2. **Terraform æ¸…ç†ï¼š** åˆ é™¤ `.terraform.lock.hcl` å’Œ `.terraform` ç›®å½•ï¼Œç„¶å `terraform init -upgrade`ã€‚          |

## ğŸ’¡ å…³é”®ç»éªŒæ•™è®­ (Best Practices)

1. **æ–‡ä»¶å­˜å‚¨å¯¹å‘½åæ•æ„Ÿï¼š** åœ¨ä½¿ç”¨ NFS/CIFS/Directory ç±»å‹çš„å­˜å‚¨ä½œä¸ºæ¨¡æ¿æºæ—¶ï¼Œè¯·å§‹ç»ˆç¡®ä¿ç£ç›˜æ–‡ä»¶åç§°éµå¾ª Proxmox çš„æ ‡å‡†æ ¼å¼ï¼ˆ`vm-VMID-disk-ID`ï¼‰ï¼Œä»¥ç¡®ä¿å…‹éš†æ“ä½œçš„å¯é æ€§ã€‚
    
2. **LVM > NFSï¼š** LVM/ZFS ç­‰å—å­˜å‚¨åœ¨å¤„ç†ç£ç›˜å…ƒæ•°æ®å’Œå…‹éš†æ“ä½œæ—¶é€šå¸¸æ¯”æ–‡ä»¶å­˜å‚¨æ›´å¥å£®ï¼Œå¯¹éæ ‡å‡†å‘½åæœ‰æ›´é«˜çš„å®¹å¿åº¦ã€‚
    
3. **é…ç½®æ–‡ä»¶æ˜¯æœ€ç»ˆçœŸç†ï¼š** å½“ Proxmox API å‘½ä»¤ï¼ˆå¦‚ `qm set` æˆ– `qm template`ï¼‰å› åº•å±‚é”™è¯¯è€Œå¤±è´¥æ—¶ï¼Œç›´æ¥ç¼–è¾‘ `/etc/pve/qemu-server/VMID.conf` æ–‡ä»¶æ˜¯è§£å†³é…ç½®æ®‹ç•™å’Œå†²çªçš„æœ€åæ‰‹æ®µã€‚
    
4. **è·¨å­˜å‚¨å…‹éš†ä¾èµ– `full_clone = true`ï¼š** ç¡®ä¿åœ¨ Terraform ä¸­è®¾ç½® `full_clone = true`ï¼Œä»¥å¼ºåˆ¶ Proxmox æ‰§è¡Œå®Œæ•´æ•°æ®å¤åˆ¶ï¼Œè€Œä¸æ˜¯å°è¯•è¿›è¡Œé“¾æ¥å…‹éš†ã€‚
